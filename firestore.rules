rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função auxiliar para verificar se é admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // Função para verificar se está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Collection: guests
    // Leitura: Público (para listagem no formulário)
    // Escrita: Apenas admin
    match /guests/{guestId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Collection: rsvp (confirmações de presença)
    // Leitura: Apenas admin
    // Escrita: Público (para que convidados possam confirmar presença)
    // Atualização: Apenas se for o próprio registro ou admin
    match /rsvp/{rsvpId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update: if isAdmin() || 
                      resource.data.guestName == request.resource.data.guestName;
      allow delete: if isAdmin();
    }
    
    // Collection: payments
    // Leitura: Apenas admin
    // Escrita: Público para criar (registrar pagamento PIX)
    // Atualização/Exclusão: Apenas admin
    match /payments/{paymentId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // Collection: settings (configurações administrativas)
    // Leitura e escrita: Apenas admin
    match /settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // Collection: admin_logs (logs de atividade admin)
    // Leitura: Apenas admin
    // Escrita: Sistema (servidor)
    match /admin_logs/{logId} {
      allow read: if isAdmin();
      allow write: if true; // Permitir criação de logs
    }
    
    // Collection: contributions (contribuições/presentes)
    // Leitura: Público
    // Escrita: Público para criar, admin para atualizar/deletar
    match /contributions/{contributionId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }
  }
}
